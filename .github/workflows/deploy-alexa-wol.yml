name: Deploy Alexa wol skill

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  deploy:
    name: Deploy Alexa wol skill
    runs-on: ubuntu-latest

    # Only run on main branch pushes or manual triggers
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ”„ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Build Information
        run: |
          echo "ğŸ—ï¸ Build Information:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "- Force Deploy: ${{ github.event.inputs.force_deploy || 'false' }}"

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Validate Environment Variables
        run: |
          echo "ğŸ” Validating required environment variables..."
          
          # Check if all required secrets are set
          if [ -z "${{ secrets.ALEXA_SKILL_ID }}" ]; then
            echo "âŒ Error: ALEXA_SKILL_ID secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.WOL_USERNAME }}" ]; then
            echo "âŒ Error: WOL_USERNAME secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.WOL_PASSWORD }}" ]; then
            echo "âŒ Error: WOL_PASSWORD secret is not set"
            exit 1
          fi
          
          echo "âœ… All required environment variables are set"

      - name: ğŸ”§ Build Lambda Package with Maven
        run: |
          echo "ğŸ”§ Building Lambda package with Maven..."
          mvn -q clean package -DskipTests
          
          # Validate build output
          if [ ! -f "target/wake-on-lan-lambda.zip" ]; then
            echo "âŒ Error: Lambda ZIP file not found: target/wake-on-lan-lambda.zip"
            echo "Maven build may have failed"
            exit 1
          fi
          
          file_size=$(du -h target/wake-on-lan-lambda.zip | cut -f1)
          echo "âœ… Lambda package created successfully ($file_size)"

      - name: ğŸ“¦ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false  # Allows capturing terraform output

      - name: ğŸ—ï¸ Terraform Init
        working-directory: terraform
        run: |
          echo "ğŸ“¦ Initializing Terraform..."
          terraform init -upgrade -input=false

      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform
        run: |
          echo "ğŸ“‹ Planning Terraform deployment..."
          terraform plan -input=false -out=tfplan \
            -var="alexa_skill_id=${{ secrets.ALEXA_SKILL_ID }}" \
            -var="wol_username=${{ secrets.WOL_USERNAME }}" \
            -var="wol_password=${{ secrets.WOL_PASSWORD }}"

      - name: ğŸš€ Terraform Apply
        working-directory: terraform
        run: |
          echo "ğŸš€ Applying Terraform changes..."
          terraform apply -auto-approve -input=false tfplan
          
          # Get Lambda ARN for output
          if terraform output lambda_arn >/dev/null 2>&1; then
            LAMBDA_ARN=$(terraform output -raw lambda_arn)
            echo "LAMBDA_ARN=$LAMBDA_ARN" >> $GITHUB_ENV
            echo "ğŸ“‹ Lambda ARN: $LAMBDA_ARN"
          else
            echo "âš ï¸ Warning: Could not retrieve Lambda ARN"
          fi

      - name: âœ… Deployment Summary
        run: |
          echo "âœ… Deployment Complete!"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "- Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "- Lambda ARN: ${{ env.LAMBDA_ARN || 'Not available' }}"
          echo "- Build Number: ${{ github.run_number }}"
          echo "- Git Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ”— Next Steps:"
          echo "1. Copy the Lambda ARN above"
          echo "2. Update your Alexa skill endpoint in the Developer Console"
          echo "3. Test your skill: 'Alexa, discover my devices'"

      - name: ğŸ“ Archive Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 30

  # Optional: Separate job for PR validation (doesn't deploy)
  validate:
    name: Validate on PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ”„ Checkout Source Code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”§ Build and Test
        run: |
          echo "ğŸ”§ Building and testing..."
          mvn clean package

      - name: ğŸ“¦ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: âœ… Terraform Validate
        working-directory: terraform
        run: |
          terraform init -backend=false
          terraform validate
